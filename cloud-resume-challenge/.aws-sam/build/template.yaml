AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'cloud-resume-challenge

  Sample SAM Template for cloud-resume-challenge

  '
Globals:
  Function:
    Timeout: 5
Parameters:
  HostedZoneParameter:
    Type: String
    Description: The hosted zone for the Route53 records
    Default: Z08034563UEGXHOK8DP5Y
  DomainNameParameter:
    Type: String
    Description: The domain name of the site
    Default: oliverbennett.net
  ApiDomainNameParameter:
    Type: String
    Description: The subdomain of the API
    Default: api.
  WebsiteDomainNameParameter:
    Type: String
    Description: The subdomain of the website
    Default: website.
  ResumeDomainNameParameter:
    Type: String
    Description: The subdomain of the resume-site
    Default: resume.
Resources:
  MyWebsite:
    Type: AWS::S3::Bucket
    Properties:
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - HEAD
          AllowedOrigins:
          - '*'
          ExposedHeaders:
          - Date
          Id: myCORSRuleId
          MaxAge: 3600
      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
      BucketName: cloud-resume-challenge-website
  MyRoute53Record:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      HostedZoneId: Z08034563UEGXHOK8DP5Y
      RecordSets:
      - Name:
          Fn::Join:
          - ''
          - - Ref: ResumeDomainNameParameter
            - Ref: DomainNameParameter
        Type: A
        AliasTarget:
          HostedZoneId: Z2FDTNDATAQYW2
          DNSName:
            Fn::GetAtt:
            - MyDistribution
            - DomainName
  MyCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName:
        Fn::Join:
        - ''
        - - '*.'
          - Ref: DomainNameParameter
      SubjectAlternativeNames:
      - Ref: DomainNameParameter
      - Fn::Join:
        - ''
        - - '*.'
          - Ref: DomainNameParameter
      DomainValidationOptions:
      - DomainName:
          Ref: DomainNameParameter
        HostedZoneId:
          Ref: HostedZoneParameter
      ValidationMethod: DNS
  MyDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        ViewerCertificate:
          AcmCertificateArn:
            Ref: MyCertificate
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1
        Aliases:
          Fn::Split:
          - ','
          - Fn::Join:
            - ''
            - - Ref: ResumeDomainNameParameter
              - Ref: DomainNameParameter
        DefaultCacheBehavior:
          AllowedMethods:
          - GET
          - HEAD
          - OPTIONS
          - PUT
          - PATCH
          - POST
          - DELETE
          ViewerProtocolPolicy: redirect-to-https
          TargetOriginId: cloud-resume-challenge-website.s3-website-us-east-1.amazonaws.com
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          OriginRequestPolicyId: 59781a5b-3903-41f3-afcb-af62929ccde1
        Origins:
        - DomainName: cloud-resume-challenge-website.s3-website-us-east-1.amazonaws.com
          Id: cloud-resume-challenge-website.s3-website-us-east-1.amazonaws.com
          CustomOriginConfig:
            OriginProtocolPolicy: match-viewer
            HTTPPort: 80
            HTTPSPort: 443
        Enabled: true
        DefaultRootObject: index.html
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Id: MyPolicy
        Version: 2012-10-17
        Statement:
        - Sid: PublicReadForGetBucketObjects
          Effect: Allow
          Principal: '*'
          Action: s3:GetObject
          Resource:
            Fn::Join:
            - ''
            - - 'arn:aws:s3:::'
              - Ref: MyWebsite
              - /*
      Bucket:
        Ref: MyWebsite
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: cloud-resume-challenge
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: ID
        AttributeType: S
      KeySchema:
      - AttributeName: ID
        KeyType: HASH
  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Domain:
        DomainName:
          Fn::Join:
          - ''
          - - Ref: ApiDomainNameParameter
            - Ref: DomainNameParameter
        CertificateArn:
          Ref: MyCertificate
        Route53:
          HostedZoneId:
            Ref: HostedZoneParameter
  GetFunction:
    Type: AWS::Serverless::Function
    Properties:
      Policies:
      - DynamoDBCrudPolicy:
          TableName: cloud-resume-challenge
      CodeUri: GetFunction
      Handler: get-function
      Runtime: go1.x
      Architectures:
      - x86_64
      Tracing: Active
      Events:
        CatchAll:
          Type: Api
          Properties:
            Path: /get
            Method: GET
            RestApiId:
              Ref: ApiGatewayApi
  PutFunction:
    Type: AWS::Serverless::Function
    Properties:
      Policies:
      - DynamoDBCrudPolicy:
          TableName: cloud-resume-challenge
      CodeUri: PutFunction
      Handler: put-function
      Runtime: go1.x
      Architectures:
      - x86_64
      Tracing: Active
      Events:
        CatchAll:
          Type: Api
          Properties:
            Path: /put
            Method: GET
            RestApiId:
              Ref: ApiGatewayApi
